# =============================================================================
# Aegis v13 - 한국 주식 종목 선정 전략 설정
# =============================================================================
# SSOT: 이 파일이 모든 선정/운용/청산 파라미터의 단일 진실 소스
# 문서: docs-site/docs/guide/strategy/stock-selection.md
# Spec: docs-site/docs/guide/strategy/implementation-spec.md
# =============================================================================

meta:
  strategy_id: "korea_equity_v13"
  version: "1.0.1"
  timezone: "Asia/Seoul"
  decision_time_local: "17:00"
  execution_window:
    start: "09:05"
    end: "15:10"

# =============================================================================
# S1: Universe (투자 가능 풀)
# =============================================================================
universe:
  # 제외할 KRX 플래그 (열거형)
  exclude_krx_flags:
    - "TRADING_HALT"
    - "ADMIN_ISSUE"
    - "MANAGEMENT"
    - "INVESTMENT_WARNING"
    - "INVESTMENT_DANGER"

  filters:
    marketcap_min_krw: 200_000_000_000   # 2,000억
    adtv20_min_krw: 2_000_000_000        # 20억
    price_min_krw: 1_000
    ipo_days_min: 180
    spread:
      max_pct: 0.006
      formula: "((ask1-bid1)/((ask1+bid1)/2))"

# =============================================================================
# S2: Signals (6팩터 점수화)
# =============================================================================
signals:
  normalization:
    winsorize_pct: 0.015
    zscore_clip: 3.0
    score_range_min: 0
    score_range_max: 100
    missing_policy: "NEUTRAL"

  momentum:
    lookbacks_days: [20, 60, 120]
    weights: [0.40, 0.35, 0.25]

  technical:
    ma_short: 20
    ma_long: 60
    slope_window: 10
    high52w_window: 252

  value:
    metrics: ["PBR", "PER"]
    per_score_cap: 80

  quality:
    metrics: ["ROE_TTM", "OP_MARGIN_TTM", "DEBT_RATIO"]

  flow:
    actors: ["FOREIGN", "INSTITUTION"]
    lookbacks_days: [5, 20]
    weights: [0.55, 0.45]
    normalize_by: "ADTV20"

  event:
    ttl_days: 10
    types: ["GAP_UP", "SURGE", "DISCLOSURE", "EARNINGS_SURPRISE"]

# =============================================================================
# S3: Screening (Hard Cut)
# =============================================================================
screening:
  drawdown:
    day1_return_min: -0.09
    day5_return_min: -0.18

  overheat:
    enable: true
    day5_return_max: 0.35

  fundamentals:
    net_income_ttm_min: 0
    per_max: 60

  volatility:
    enable: true
    vol20_exclude_top_pct: 0.10

# =============================================================================
# S4: Ranking (가중치)
# =============================================================================
ranking:
  weights_pct:
    momentum: 25
    flow: 20
    technical: 15
    event: 15
    value: 15
    quality: 10

  constraints:
    momentum_plus_technical_max_pct: 50
    monthly_weight_change_max_pctpt: 5

# =============================================================================
# S5: Portfolio (포트폴리오 구성)
# =============================================================================
portfolio:
  holdings:
    target: 20
    min: 15
    max: 20

  allocation:
    cash_target_pct: 0.10
    position_min_pct: 0.04
    position_max_pct: 0.10
    sector_max_pct: 0.25
    turnover_daily_max_pct: 0.20

  weighting:
    method: "TIERED"
    tiers:
      # 합: 5×5% + 10×4.5% + 5×4% = 25% + 45% + 20% = 90%
      # 주식 90% + 현금 10% = 100%
      # 모든 tier가 position_min_pct(4%) 이상 충족
      - { count: 5,  weight_each_pct: 0.05 }
      - { count: 10, weight_each_pct: 0.045 }
      - { count: 5,  weight_each_pct: 0.04 }

  liquidity_caps:
    max_order_to_adtv20_pct: 0.02
    max_participation_per_minute_pct: 0.10

# =============================================================================
# Execution (주문 집행)
# =============================================================================
execution:
  order_type: "LIMIT"
  limit_policy:
    buy: "ASK1"
    sell: "BID1"

  # avoid_open_minutes, avoid_close_minutes 삭제됨
  # execution_window.start/end로 통합

  splitting:
    enable: true
    trigger_order_to_adtv20_pct_ge: 0.02
    min_slices: 3
    max_slices: 8
    interval_seconds: 90

  slippage_model:
    segments:
      - { adtv20_min_krw: 5_000_000_000, slippage_pct: 0.0025 }
      - { adtv20_min_krw: 2_000_000_000, slippage_pct: 0.0045 }
      - { adtv20_min_krw: 0,             slippage_pct: 0.0070 }

# =============================================================================
# Exit (청산 전략)
# =============================================================================
exit:
  mode: "ATR"

  fixed:
    stop_loss_pct: -0.07
    trail_activate_pct: 0.06
    trail_drawdown_pct: -0.05
    time_stop_days: 10
    partial_take_profit:
      enable: true
      trigger_ret_pct: 0.18
      sell_fraction_pct: 0.50

  atr:
    window_days: 20
    stop_mult: 2.0
    trail_mult: 1.5
    min_stop_pct: 0.07
    min_trail_pct: 0.05

# =============================================================================
# Risk Overlay (리스크 조정)
# =============================================================================
risk_overlay:
  nasdaq_adjust:
    enable: true
    run_time_local: "08:00"
    triggers:
      - { nasdaq_ret_le: -0.030, scale_equity_pct: -0.30 }
      - { nasdaq_ret_le: -0.015, scale_equity_pct: -0.15 }
      - { nasdaq_ret_ge:  0.015, scale_equity_pct:  0.10 }
    clamp:
      min_equity_exposure_pct: 0.60
      max_equity_exposure_pct: 1.00

# =============================================================================
# Backtest Costs (백테스트 비용 가정)
# =============================================================================
backtest_costs:
  commission_bps: 1.5
  tax_bps: 23.0
  apply_slippage_model: true
