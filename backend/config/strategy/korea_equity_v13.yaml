# =============================================================================
# Aegis v13 - 한국 주식 종목 선정 전략 설정
# =============================================================================
# SSOT: 이 파일이 모든 선정/운용/청산 파라미터의 단일 진실 소스
# 문서: docs-site/docs/guide/strategy/stock-selection.md
# Spec: docs-site/docs/guide/strategy/implementation-spec.md
# =============================================================================

meta:
  strategy_id: "korea_equity_v13"
  version: "1.0.1"
  timezone: "Asia/Seoul"
  decision_time_local: "17:00"
  execution_window:
    start: "09:05"
    end: "15:10"

# =============================================================================
# S1: Universe (투자 가능 풀)
# =============================================================================
universe:
  # 제외할 KRX 플래그 (열거형)
  exclude_krx_flags:
    - "TRADING_HALT"
    - "ADMIN_ISSUE"
    - "MANAGEMENT"
    - "INVESTMENT_WARNING"
    - "INVESTMENT_DANGER"

  filters:
    marketcap_min_krw: 200_000_000_000   # 2,000억
    adtv20_min_krw: 2_000_000_000        # 20억
    price_min_krw: 1_000
    ipo_days_min: 180
    spread:
      max_pct: 0.006
      formula: "((ask1-bid1)/((ask1+bid1)/2))"

# =============================================================================
# S2: Signals (6팩터 점수화)
# =============================================================================
signals:
  normalization:
    winsorize_pct: 0.015
    zscore_clip: 3.0
    score_range_min: 0
    score_range_max: 100
    missing_policy: "NEUTRAL"

  momentum:
    lookbacks_days: [20, 60, 120]
    weights: [0.40, 0.35, 0.25]

  technical:
    ma_short: 20
    ma_long: 60
    slope_window: 10
    high52w_window: 252

  value:
    metrics: ["PBR", "PER"]
    per_score_cap: 80

  quality:
    metrics: ["ROE_TTM", "OP_MARGIN_TTM", "DEBT_RATIO"]

  flow:
    actors: ["FOREIGN", "INSTITUTION"]
    lookbacks_days: [5, 20]
    weights: [0.55, 0.45]
    normalize_by: "ADTV20"

  event:
    ttl_days: 10
    types: ["GAP_UP", "SURGE", "DISCLOSURE", "EARNINGS_SURPRISE"]

# =============================================================================
# S3: Screening (Hard Cut)
# =============================================================================
screening:
  # 1. 재무 Hard Cut
  fundamentals:
    per_min: 0              # PER > 0 (적자 제외)
    per_max: 50             # PER <= 50 (고평가 제외)
    pbr_min: 0.2            # PBR >= 0.2 (자산가치 필터)
    roe_min: 5              # ROE >= 5% (수익성 필터)

  # 2. 급락 제외
  drawdown:
    day1_return_min: -0.09  # 1일 수익률 >= -9%
    day5_return_min: -0.18  # 5일 수익률 >= -18%

  # 3. 과열 제외
  overheat:
    enable: true
    day5_return_max: 0.35   # 5일 수익률 <= 35%

  # 4. 변동성 제외
  volatility:
    enable: true
    vol20_exclude_top_pct: 0.10  # 상위 10% 제외

# =============================================================================
# S4: Ranking (가중치)
# =============================================================================
ranking:
  weights_pct:
    momentum: 25
    flow: 20
    technical: 15
    event: 15
    value: 15
    quality: 10

  constraints:
    momentum_plus_technical_max_pct: 50
    monthly_weight_change_max_pctpt: 5

# =============================================================================
# S5: Portfolio (포트폴리오 구성)
# =============================================================================
portfolio:
  holdings:
    target: 20
    min: 15
    max: 20

  allocation:
    cash_target_pct: 0.10
    position_min_pct: 0.04
    position_max_pct: 0.10
    sector_max_pct: 0.25
    turnover_daily_max_pct: 0.20

  weighting:
    method: "TIERED"
    tiers:
      # 합: 5×5% + 10×4.5% + 5×4% = 25% + 45% + 20% = 90%
      # 주식 90% + 현금 10% = 100%
      # 모든 tier가 position_min_pct(4%) 이상 충족
      - { count: 5,  weight_each_pct: 0.05 }
      - { count: 10, weight_each_pct: 0.045 }
      - { count: 5,  weight_each_pct: 0.04 }

  liquidity_caps:
    max_order_to_adtv20_pct: 0.02
    max_participation_per_minute_pct: 0.10

# =============================================================================
# Execution (주문 집행)
# =============================================================================
execution:
  order_type: "LIMIT"
  limit_policy:
    buy: "ASK1"
    sell: "BID1"

  # avoid_open_minutes, avoid_close_minutes 삭제됨
  # execution_window.start/end로 통합

  splitting:
    enable: true
    trigger_order_to_adtv20_pct_ge: 0.02
    min_slices: 3
    max_slices: 8
    interval_seconds: 90

  slippage_model:
    segments:
      - { adtv20_min_krw: 5_000_000_000, slippage_pct: 0.0025 }
      - { adtv20_min_krw: 2_000_000_000, slippage_pct: 0.0045 }
      - { adtv20_min_krw: 0,             slippage_pct: 0.0070 }

# =============================================================================
# Exit (청산 전략) - ATR 기반 동적 청산 v1.2.0
# SSOT: docs-site/docs/guide/strategy/exit-rules.md
# =============================================================================
exit:
  mode: "ATR"
  use_atr_based: true

  # ===== 3단계 분할 익절 =====
  take_profit:
    # TP1: ATR × 1.5, clamp [6%, 8%], 25% 매도
    tp1:
      atr_multiplier: 1.5
      min_percent: 6.0
      max_percent: 8.0
      sell_percent: 25.0

    # TP2: ATR × 2.5, clamp [10%, 12%], 25% 매도
    tp2:
      atr_multiplier: 2.5
      min_percent: 10.0
      max_percent: 12.0
      sell_percent: 25.0

    # TP3: ATR × 3.5, clamp [15%, 18%], 20% 매도
    tp3:
      atr_multiplier: 3.5
      min_percent: 15.0
      max_percent: 18.0
      sell_percent: 20.0

  # ===== 2단계 손절 =====
  stop_loss:
    first_stop_percent: -3.0      # 1차 손절 트리거
    first_stop_sell_percent: 50.0 # 1차 손절 시 50% 매도
    second_stop_percent: -5.0     # 2차 손절 (전량)
    hard_stop_percent: -7.0       # 하드 스탑 (어떤 상황에서도 발동)

  # ===== 보호 메커니즘 =====
  protection:
    # Stop Floor: TP1 이후 손익분기점 + buffer
    stop_floor_buffer: 0.6        # 손익분기점 + 0.6%

    # HWM Trailing: TP3 이후 최고가 추적
    trail_atr_multiplier: 2.0     # 트레일 ATR 배수
    trail_min_percent: 3.0        # 최소 트레일 거리
    trail_max_percent: 5.0        # 최대 트레일 거리

  # ===== 모니터링 =====
  check_interval_seconds: 30

# =============================================================================
# Risk Overlay (리스크 조정)
# =============================================================================
risk_overlay:
  nasdaq_adjust:
    enable: true
    run_time_local: "08:00"
    triggers:
      - { nasdaq_ret_le: -0.030, scale_equity_pct: -0.30 }
      - { nasdaq_ret_le: -0.015, scale_equity_pct: -0.15 }
      - { nasdaq_ret_ge:  0.015, scale_equity_pct:  0.10 }
    clamp:
      min_equity_exposure_pct: 0.60
      max_equity_exposure_pct: 1.00

# =============================================================================
# Backtest Costs (백테스트 비용 가정)
# =============================================================================
backtest_costs:
  commission_bps: 1.5
  tax_bps: 23.0
  apply_slippage_model: true
